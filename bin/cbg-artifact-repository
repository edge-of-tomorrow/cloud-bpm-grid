#!/bin/sh

source $CBG_HOME/conf/base.cfg

# Cloud BPM Grid - Artifact Repository

HELP="""
Usage: cbg-artifact-repository COMMAND
       cbg-artifact-repository --help

Artifact repository Nexus 3 for Cloud BPM Grid.

COMMANDS:
    setup \t Create persistent storage for Nexus data and download Nexus 3 Docker image
    start \t Start Nexus 3 in Docker container
    restart \t Restart Nexus 3 in Docker container
    open \t Open Nexus 3 in Browser
    stop \t Stop Nexus 3 in Docker container
    clear \t Clear persistent storage for Nexus data
"""

case $1 in
    setup)
        if [ -d "$NEXUS_DATA" ]; then
            rm -rf $NEXUS_DATA
        fi
        mkdir -p -m 777 $NEXUS_DATA
        docker pull sonatype/nexus3
    ;;
    build|rebuild)
        # nothing to do
    ;;
    start)
        docker run -d -p $NEXUS_PORT:8081 --name artifact-repository -v $NEXUS_DATA:/nexus-data sonatype/nexus3
    ;;
    restart)
        docker rm -f artifact-repository
        docker run -d -p $NEXUS_PORT:8081 --name artifact-repository -v $NEXUS_DATA:/nexus-data sonatype/nexus3
    ;;
    open)
        if which xdg-open > /dev/null
        then
          xdg-open "http://$NEXUS_HOST:$NEXUS_PORT"
        elif which gnome-open > /dev/null
        then
          gnome-open "http://$NEXUS_HOST:$NEXUS_PORT"
        fi
    ;;
    stop)
        docker rm -f artifact-repository
    ;;
    clear)
        rm -rf $NEXUS_DATA
    ;;
    *)
    echo -e "$HELP"
    ;;
esac

