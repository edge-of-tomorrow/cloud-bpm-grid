#!/bin/sh

source $CBG_HOME/conf/base.cfg

# Cloud BPM Grid - Authentication Server

HELP="""
Usage: cbg-authentication-server COMMAND
       cbg-authentication-server --help

Authentication Server KeyCloak for Cloud BPM Grid.

COMMANDS:
    setup \t Download KeyCloak Docker image
    start \t Start KeyCloak authentication server in Docker container
    restart \t Restart KeyCloak authentication server in Docker container
    stop \t Stop KeyCloak authentication server in Docker container
    clear \t No-op
"""

case $1 in
    setup)
        docker pull jboss/keycloak-postgres
    ;;
    build|rebuild)
        # nothing to do
    ;;
    start)
        if [ "$DB_INIT" = true ] ; then
            docker run -d -p $AUTH_PORT:8080 --link bpm-database:postgres -e POSTGRES_DATABASE=$DB_NAME -e POSTGRES_USER=$DB_USER -e POSTGRES_PASSWORD=$DB_PWD -e KEYCLOAK_USER=$AUTH_USER -e KEYCLOAK_PASSWORD=$AUTH_PWD --name authentication-server jboss/keycloak-postgres
        else
            echo "Use of database out of Docker container is not supported right now."
        fi
    ;;
    restart)
        docker rm -f authentication-server
        if [ "$DB_INIT" = true ] ; then
            docker run -d -p $AUTH_PORT:8080 --link bpm-database:postgres -e POSTGRES_DATABASE=$DB_NAME -e POSTGRES_USER=$DB_USER -e POSTGRES_PASSWORD=$DB_PWD -e KEYCLOAK_USER=$AUTH_USER -e KEYCLOAK_PASSWORD=$AUTH_PWD --name authentication-server jboss/keycloak-postgres
        else
            echo "Use of database out of Docker container is not supported right now."
        fi
    ;;
    stop)
        docker rm -f authentication-server
    ;;
    clear)
        # nothing to do
    ;;
    *)
    echo -e "$HELP"
    ;;
esac

